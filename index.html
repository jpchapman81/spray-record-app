<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Julius Ag Spray Record</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 40px auto;
      max-width: 700px;
      background-color: #f7f7f7;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      border-radius: 10px;
    }

    h2 {
      text-align: center;
      color: #2a4d69;
    }

    label {
      font-weight: bold;
      margin-top: 15px;
      display: block;
    }

    input[type="text"],
    input[type="number"],
    input[type="date"],
    select,
    textarea {
      width: 100%;
      padding: 10px;
      margin-top: 4px;
      margin-bottom: 12px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
    }

    textarea {
      resize: vertical;
    }

    button {
      background-color: #2a4d69;
      color: white;
      border: none;
      padding: 10px 16px;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      margin-right: 10px;
    }

    button:hover {
      background-color: #1d3557;
    }
  
    canvas {
      width: 100%;
      height: 150px;
      border: 1px solid #aaa;
      border-radius: 6px;
      background-color: white;
      margin-bottom: 12px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    table th, table td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
    }

    table th {
      background-color: #2a4d69;
      color: white;
    }

    #customCompanyContainer {
      margin-bottom: 12px;
    }

  .print-record {
    font-family: 'Segoe UI', sans-serif;
    padding: 30px;
    color: #000;
    max-width: 750px;
    margin: auto;
  }

  .print-header {
    text-align: center;
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 30px;
  }

  .print-section {
    margin-bottom: 18px;
  }

  .print-section label {
    font-weight: bold;
    display: inline-block;
    width: 180px;
  }


    </style>
</head>

<body>

<h2>Julius Ag Spray Record</h2>

<form id="sprayForm">

  <label>Job Number:</label>
  <input type="text" id="jobNumber" value="1000" readonly>

  <label>Date:</label>
  <input type="date" id="date" required>

  <label>Company:</label>
  <select id="company" onchange="handleCompanyChange()" required>
    <option value="">Loading companies...</option>
    <option value="Other">Other</option>
  </select>

  <div id="customCompanyContainer" style="display:none;">
    <label>Custom Company Name:</label>
    <input type="text" id="customCompany">
  </div>

  <label>Client Address:</label>
  <input type="text" id="clientAddress" required>

  <label>Location:</label>
  <input type="text" id="location" required>

  <label>Ownership:</label>
  <select id="ownership" required>
    <option value="">Select Ownership</option>
    <option value="Private">Private</option>
    <option value="BLM">BLM</option>
    <option value="Federal">Federal</option>
    <option value="Other">Other</option>
  </select>

<label>Start Time:</label>
<input type="time" id="startTime" required>

<label>End Time:</label>
<input type="time" id="endTime" required>

<label>Number of Applicators:</label>
<input type="number" id="numApplicators" value="1" min="1" required>

<label>Total Hours:</label>
<input type="text" id="totalHours" readonly>

<label>Hourly Rate ($):</label>
<input type="number" id="hourlyRate" value="95" required>

<label>Labor Cost ($):</label>
<input type="text" id="laborCost" readonly>

<label>Temperature (°F):</label>
<input type="number" id="temperature" required>

<label>Humidity (%):</label>
<input type="number" id="humidity" required>

<label>Wind Speed (mph):</label>
<input type="number" id="windSpeed" required>

<label>Wind Direction:</label>
<input type="text" id="windDirection" required>

  <label>Sprayer Type:</label>
  <select id="sprayerType" required>
    <option value="">Select Sprayer Type</option>
    <option value="Boom">Boom</option>
    <option value="Backpack">Backpack</option>
    <option value="ATV">ATV</option>
    <option value="Truck Mount">Truck Mount</option>
  </select>

  <label>Calibration Rate (gal/acre):</label>
  <input type="number" id="calibrationRate" step="1" min="1" required>

  <label>Gallons Applied:</label>
  <input type="number" id="gallonsApplied" step="1" min="1" required>

  <label>Tank Mix:</label>
  <select id="tankMix" onchange="updateChemicals()" required>
    <option value="">Loading mixes...</option>
  </select>

  <div id="chemicalsTableContainer"></div>

  <label>Applicators:</label>
  <input type="text" id="applicators" required>

  <label>GPS Coordinates:</label>
  <input type="text" id="gps" required>

  <h3>Signature:</h3>
  <canvas id="signatureCanvas"></canvas>
  <button type="button" onclick="clearSignature()">Clear Signature</button>

  <br><br>
  <button type="button" onclick="submitForm()">Submit Record</button>
  <button type="button" onclick="clearForm()">Clear Record</button>


</form>

<script>

// Load last job number or start at 1000
window.addEventListener("DOMContentLoaded", () => {
  const savedJobNumber = localStorage.getItem("jobNumber");
  const jobInput = document.getElementById("jobNumber");
  jobInput.value = savedJobNumber ? parseInt(savedJobNumber) : 1000;
});

let companyList = [];

fetch("https://opensheet.elk.sh/18G6oH9M5SrvJ2gCRLXQgvqB_8KO4qcYL5dUNZtw4VnM/Companies")
  .then(res => res.json())
  .then(data => {
    companyList = data;
    const companySelect = document.getElementById("company");
    companySelect.innerHTML = '<option value="">Select Company</option>';
    
    data.forEach(row => {
      const opt = document.createElement("option");
      opt.value = row["Company Name"];
      opt.textContent = row["Company Name"];
      companySelect.appendChild(opt);
    });

    // Always include "Other" at the end
    const otherOpt = document.createElement("option");
    otherOpt.value = "Other";
    otherOpt.textContent = "Other";
    companySelect.appendChild(otherOpt);
  });

function handleCompanyChange() {
  const selected = document.getElementById("company").value;
  const customContainer = document.getElementById("customCompanyContainer");
  const addressInput = document.getElementById("clientAddress");

  if (selected === "Other") {
    customContainer.style.display = "block";
    addressInput.value = '';
    addressInput.readOnly = false;
  } else {
    customContainer.style.display = "none";
    const row = companyList.find(c => c["Company Name"] === selected);
    addressInput.value = row ? row.Address : '';
    addressInput.readOnly = true;
  }
}

document.getElementById('tankMix').addEventListener('change', function() {
  const mix = this.value;
  let chemicals = '';
  if (mix === 'Esplanade Mix') {
    chemicals = "Esplanade 432-1516: 5 oz\nAntares Pro 82534-5-5905: 10 oz\nRoundup Pro 524-529: 64 oz\nGrounded: 32 oz\nDye: 32 oz";
  } else if (mix === 'Trumpcard Mix') {
    chemicals = "TrumpCard 5905-581: 48 oz\nVision 5905-576: 13 oz\nInduce: 20.48 oz\nDye: 16 oz";
  } else if (mix === 'Milestone Mix') {
    chemicals = "TrumpCard 5905-581: 48 oz\nMilestone 62719-519: 6 oz\nTelar 264-770: 1 oz\nInduce: 20.48 oz\nDye: 16 oz";
  }
  document.getElementById('chemicals').value = chemicals;
});

function clearSignature() {
  const canvas = document.getElementById('signatureCanvas');
  const context = canvas.getContext('2d');
  context.clearRect(0, 0, canvas.width, canvas.height);
}

const signaturePad = (() => {
  const canvas = document.getElementById('signatureCanvas');
  const ctx = canvas.getContext('2d');
  let drawing = false;

  canvas.addEventListener('mousedown', e => {
    drawing = true;
    ctx.moveTo(e.offsetX, e.offsetY);
  });

  canvas.addEventListener('mousemove', e => {
    if (drawing) {
      ctx.lineTo(e.offsetX, e.offsetY);
      ctx.stroke();
    }
  });

  canvas.addEventListener('mouseup', () => drawing = false);
  canvas.addEventListener('mouseout', () => drawing = false);

  return {
    toDataURL: () => canvas.toDataURL()
  };
})();


function submitForm() {
  const jobNumber = document.getElementById("jobNumber").value;
  const date = document.getElementById("date").value;

  const companySelect = document.getElementById("company").value;
  const customCompany = document.getElementById("customCompany").value;
  const company = companySelect === "Other" ? (customCompany || "Other") : companySelect;

    const temperature = document.getElementById("temperature").value;
  const humidity = document.getElementById("humidity").value;
  const windSpeed = document.getElementById("windSpeed").value;
  const windDirection = document.getElementById("windDirection").value;

  const newWindow = window.open('', '', 'width=800,height=1000');
  newWindow.document.write('<html><head><title>Julius Ag Application Record</title><style>');
  newWindow.document.write(`
    body {
      font-family: 'Segoe UI', sans-serif;
      max-width: 800px;
      margin: auto;
      padding: 40px;
      color: #000;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    .section {
      margin-bottom: 25px;
    }
    .section label {
      font-weight: bold;
      display: inline-block;
      width: 180px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #444;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #ddd;
    }
    .signature {
      margin-top: 40px;
    }
    dl dt {
      font-weight: bold;
      margin-top: 10px;
    }
    dl dd {
      margin-left: 20px;
      margin-bottom: 10px;
    }

  `);
  newWindow.document.write('</style></head><body>');

  // Logo
 newWindow.document.write('<div style="text-align:center;"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOEAAADhCAYAAAA+5+2cAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH5QgaEBMNSZPUPgAABARJREFUeNrt3dFx4jgYBuGv8Afw/5c4J/0GGIArxRthY5kKv2+vNeXAkRLZMmUgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADwMPlFYY31Zrfalvb7L1xj1Zrb9/av1X2fHOi/XLaemz3tO/xC/ZV6XvmzVVZ3b/NuSpdHHo/kWbPntZX5X7abmz7tx+W+8pyu9mfZuW7yzNVaz3d92k9yf+X7Q/Nu8/WXHZr3+u8tyu3JtXef9Jc2/N+9V5v2/NftvL/XrZ68wW61bXyz0G/NdrZ+rdq71+au7uqdXGrfq7P/Fs9b6Y3Z7Xr67h/n28mzWaHvdf8un53ddrbbvX+w+Ov8LPv9ZH7Fubvk5uZlv5e+Z9W9w6W2v+Rbl+6ddQeau6Xz+dX8xO5Wu1vZ6W5et75q7uqlbxvqpR5qX5cvdf6Zu1vz7dvZWz9Pfzff3T84fZuzYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgfQfHlBXy7hskmZQAAAAASUVORK5CYII=" style="max-width:250px; margin-bottom:20px;"></div>');

  newWindow.document.write('<h1>Pesticide Application Record</h1>');

  // Section: Job Info
    newWindow.document.write('<div class="section"><dl>');
    newWindow.document.write(`<dt>Job Number:</dt><dd>${jobNumber}</dd>`);
    newWindow.document.write(`<dt>Date:</dt><dd>${date}</dd>`);
    newWindow.document.write(`<dt>Company:</dt><dd>${company}</dd>`);
    newWindow.document.write(`<dt>Client Address:</dt><dd>${clientAddress}</dd>`);
    newWindow.document.write(`<dt>Location:</dt><dd>${location}</dd>`);
    newWindow.document.write(`<dt>Ownership:</dt><dd>${ownership}</dd>`);
    newWindow.document.write(`<dt>Sprayer Type:</dt><dd>${sprayerType}</dd>`);
    newWindow.document.write('</dl></div>');

  // Section: Timing & Weather
  newWindow.document.write('<div class="section">');
  newWindow.document.write('<label>Start Time:</label> ' + startTime + '<br>');
  newWindow.document.write('<label>End Time:</label> ' + endTime + '<br>');
  newWindow.document.write(`<dt>Total Hours:</dt><dd>${totalHours}</dd>`);
  newWindow.document.write(`<dt>Hourly Rate:</dt><dd>$${rate}</dd>`);
  newWindow.document.write(`<dt>Labor Cost:</dt><dd>$${laborCost}</dd>`);
  newWindow.document.write('<label>Temperature:</label> ' + temperature + '°F<br>');
  newWindow.document.write('<label>Humidity:</label> ' + humidity + '%<br>');
  newWindow.document.write('<label>Wind Speed:</label> ' + windSpeed + ' mph<br>');
  newWindow.document.write('<label>Wind Direction:</label> ' + windDirection + '<br>');
  newWindow.document.write('</div>');

  // Section: Application Rate
  newWindow.document.write('<div class="section">');
  newWindow.document.write('<label>Gallons Applied:</label> ' + gallonsApplied + '<br>');
  newWindow.document.write('<label>Calibration Rate:</label> ' + calibration + ' gal/acre<br>');
  newWindow.document.write('<label>Acres Treated:</label> ' + acresTreated + '<br>');
  newWindow.document.write('</div>');

  // Section: Chemicals Table
  const selectedMixName = document.getElementById("tankMix").value;
  const mix = tankMixes[selectedMixName];

  newWindow.document.write('<div class="section"><h3>Herbicide/Adjuvant Usage</h3>');
  newWindow.document.write('<table><tr><th>Chemical</th><th>Ounces per Acre</th><th>Total Used (oz)</th></tr>');

  if (mix) {
    for (let i = 1; i <= 6; i++) {
      const chem = mix[`Chemical${i}`];
      const oz = parseFloat(mix[`Amount${i}`]);
      if (chem && oz) {
        const totalUsed = ((gallonsApplied / calibration) * oz).toFixed(2);
        newWindow.document.write(`<tr><td>${chem}</td><td>${oz}</td><td>${totalUsed}</td></tr>`);
      }
    }
  }

  newWindow.document.write('</table></div>');

  // Signature
  newWindow.document.write('<div class="signature"><strong>Signature:</strong><br><br>');
  newWindow.document.write('<img src="' + signaturePad.toDataURL() + '" style="border:1px solid #000; width:300px; height:auto;" /></div>');

  newWindow.document.write('<p style="margin-top:20px;">Commercial Applicators are licensed by the Colorado Department of Agriculture</p>');
  newWindow.document.write('</body></html>');

  // Save and increment job #
  const jobInput = document.getElementById("jobNumber");
  let nextJob = parseInt(jobInput.value) + 1;
  jobInput.value = nextJob;
  localStorage.setItem("jobNumber", nextJob);

  // Clear signature
  clearSignature();
}



  function clearForm() {
    const jobNumber = document.getElementById("jobNumber").value;
    document.getElementById("sprayForm").reset();
    document.getElementById("jobNumber").value = jobNumber;
    clearSignature();
    toggleCustomCompany();
}

let tankMixData = [];

fetch("https://opensheet.elk.sh/18G6oH9M5SrvJ2gCRLXQgvqB_8KO4qcYL5dUNZtw4VnM/Tank%20Mixes")
  .then(res => res.json())
  .then(data => {
    tankMixData = data;
    const tankMixSelect = document.getElementById("tankMix");
    tankMixSelect.innerHTML = '<option value="">Select Mix</option>';
    data.forEach(row => {
      const opt = document.createElement("option");
      opt.value = row.Name;
      opt.textContent = row.Name;
      tankMixSelect.appendChild(opt);
    });
  })
  .catch(err => {
    console.error("Error loading mixes:", err);
    document.getElementById("tankMix").innerHTML = '<option value="">Error loading</option>';
  });

  function updateChemicals() {
    const selectedName = document.getElementById("tankMix").value;
    const row = tankMixData.find(mix => mix.Name === selectedName);
    if (!row) return;

    const tableHTML = ['<table border="1" cellpadding="6"><tr><th>Chemical</th><th>Amount</th></tr>'];

    let i = 1;
    while (row[`Chemical${i}`] || row[`Amount${i}`]) {
      const chem = row[`Chemical${i}`] || '';
      const amt = row[`Amount${i}`] || '';
      if (chem || amt) {
        tableHTML.push(`<tr><td>${chem}</td><td>${amt}</td></tr>`);
      }
      i++;
    }

    tableHTML.push('</table>');
    document.getElementById("chemicalsTableContainer").innerHTML = tableHTML.join('');
  }

</script>

</body>
</html>
